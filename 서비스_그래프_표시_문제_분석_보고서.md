# 🔍 서비스 그래프 표시 문제 분석 보고서

## 📋 개요
Grafana 서비스 그래프에서 본인 서비스(`hyunwoo`)가 표시되지 않는 문제를 분석하고, 다른 팀원(현준이)의 서비스가 표시되는 이유를 파악한 보고서입니다.

---

## 🎯 문제 상황

### **현상**
- **테이블(Traces)**: 본인 서비스 `hyunwoo`의 모든 API 호출이 정상 표시 ✅
- **서비스 그래프(Node Graph)**: 본인 서비스가 표시되지 않음 ❌
- **다른 팀원**: `aks-demo-backend`, `hyunjun-backend` 등이 서비스 그래프에 표시됨 ✅

### **질문**
> "동일한 요청을 보내는데 왜 현준이 것만 그래프에 나오고 본인 것은 안 나올까?"

---

## 🔍 원인 분석

### 1️⃣ **OpenTelemetry 설정 방식 차이**

#### **현준이 (hyunjun-backend)**
```yaml
env:
- name: TEMPO_ENDPOINT
  value: http://collector.lgtm.20.249.154.255.nip.io/v1/traces
- name: OTLP_ENDPOINT  
  value: http://collector.lgtm.20.249.154.255.nip.io
- name: LOKI_ENDPOINT
  value: http://collector.lgtm.20.249.154.255.nip.io/loki/api/v1/push
- name: BACKEND_SERVICE_NAME
  value: hyunjun-backend
```

#### **본인 (hyunwoo)**
```yaml
env:
- name: OTEL_EXPORTER_OTLP_ENDPOINT
  value: http://collector.lgtm.20.249.154.255.nip.io
- name: OTEL_SERVICE_NAME
  value: hyunwoo
```

### 2️⃣ **데이터 전송 경로 차이**

#### **현준이의 데이터 흐름**
```
hyunjun-backend → Tempo (직접) → 서비스 그래프 ✅
hyunjun-backend → Loki (직접) → 로그 ✅
```

#### **본인의 데이터 흐름**
```
hyunwoo → Collector → Tempo → 서비스 그래프 ❌ (SpanMetrics 없음)
hyunwoo → Collector → Loki → 로그 ✅
```

### 3️⃣ **Collector 설정 문제**

#### **현재 Collector 상태**
- **메트릭 엔드포인트**: `http://collector.lgtm.20.249.154.255.nip.io:8889/metrics`
- **응답**: 0줄 (완전히 비어있음)
- **SpanMetrics 프로세서**: 없음 ❌
- **ServiceGraph 프로세서**: 없음 ❌

#### **필요한 Collector 설정**
```yaml
processors:
  servicegraph: {}     # 서비스 간 엣지 집계
  spanmetrics:
    metrics_exporter: prometheusremotewrite

exporters:
  prometheusremotewrite:
    endpoint: http://grafana-vm:9090/api/v1/write

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [servicegraph, spanmetrics]
      exporters: [otlp]
    metrics:
      receivers: [otlp]
      exporters: [prometheusremotewrite]
```

---

## 📊 로그 생성 방식 비교

### **현준이: 하이브리드 방식**

#### **로그 형태**
```bash
[2025-08-31 15:42:50,186] INFO in app: Redis에서 메시지 181개 조회
[2025-08-31 15:42:50,218] INFO in _internal: 10.244.11.138 - - [31/Aug/2025 15:42:50] "GET /db/messages?offset=0&limit=20 HTTP/1.1" 200 -
```

#### **특징**
- **수동 로깅**: 코드에서 직접 `logger.info()` 호출
- **커스텀 로깅**: `INFO in app: Redis에서 메시지 181개 조회`
- **Flask 기본 로깅**: HTTP 요청 로그
- **직접 연결**: Tempo/Loki 엔드포인트 직접 사용

### **본인: OpenTelemetry 자동 계측**

#### **로그 형태**
```bash
10.244.11.59 - - [31/Aug/2025 16:40:18] "POST /db/message HTTP/1.1" 200 -
10.244.11.59 - - [31/Aug/2025 16:40:18] "GET /logs/kafka HTTP/1.1" 200 -
```

#### **특징**
- **자동 계측**: OpenTelemetry가 자동으로 추적 데이터 생성
- **Flask 기본 로깅만**: HTTP 요청 로그만
- **Collector 경유**: 중간 경유로 인한 메트릭 변환 필요

---

## 🎯 핵심 차이점 요약

| 구분 | 현준이 (hyunjun-backend) | 본인 (hyunwoo) |
|------|-------------------------|----------------|
| **로그 방식** | 수동 로깅 + Flask 로깅 | OpenTelemetry 자동 계측 |
| **데이터 전송** | Tempo/Loki 직접 연결 | Collector 경유 |
| **서비스 그래프** | ✅ 표시됨 | ❌ 표시 안됨 |
| **추적 데이터** | ✅ 정상 | ✅ 정상 |
| **메트릭 생성** | Tempo에서 직접 | Collector에서 변환 필요 |
| **장점** | 확실한 메트릭 생성 | 코드 수정 없이 자동 추적 |
| **단점** | 로그 코드 직접 작성 | Collector 설정 의존성 |

---

## 🔧 해결 방안

### **A) 현준이 방식으로 변경 (권장)**

#### **1단계: 환경변수 추가**
```yaml
# k8s/backend-deployment.yaml에 추가
env:
- name: TEMPO_ENDPOINT
  value: http://collector.lgtm.20.249.154.255.nip.io/v1/traces
- name: LOKI_ENDPOINT
  value: http://collector.lgtm.20.249.154.255.nip.io/loki/api/v1/push
- name: BACKEND_SERVICE_NAME
  value: hyunwoo-backend
```

#### **2단계: 애플리케이션 코드 수정**
```python
# backend/app.py에 추가
import logging
logger = logging.getLogger(__name__)

@app.route('/db/messages', methods=['GET'])
def get_from_db():
    # 기존 코드...
    logger.info(f"사용자 {user_id}가 메시지 {len(messages)}개 조회")
    return jsonify(messages)
```

### **B) 현재 방식 유지 (임시 해결)**

#### **1단계: 서비스명 통일**
```yaml
# k8s/backend-deployment.yaml
- name: OTEL_SERVICE_NAME
  value: "hyunwoo-backend"  # 다른 팀원들과 일관성
```

#### **2단계: Grafana 필터 조정**
- 서비스 그래프에서 `hyunwoo-backend` 필터 추가
- 시간 범위를 `Last 6 hours`로 확장

### **C) 시스템 관리자 요청 (근본 해결)**

#### **Collector 설정 수정 요청**
144번 클러스터의 OpenTelemetry Collector에 SpanMetrics/ServiceGraph 프로세서 추가 요청

---

## 📈 예상 결과

### **현준이 방식 적용 시**
- **서비스 그래프**: ✅ `hyunwoo-backend` 표시
- **추적 데이터**: ✅ 기존과 동일
- **로그 품질**: ⭐ 향상 (상세한 비즈니스 로그)
- **유지보수**: ⚠️ 로그 코드 직접 관리 필요

### **현재 방식 유지 시**
- **서비스 그래프**: ❌ 여전히 표시 안됨
- **추적 데이터**: ✅ 기존과 동일
- **로그 품질**: ⚠️ 기본 HTTP 로그만
- **유지보수**: ✅ 자동 계측으로 관리 편함

---

## 🎯 권장사항

### **단기 해결책**
1. **서비스명 통일**: `hyunwoo-backend`로 변경
2. **Grafana 필터 조정**: 서비스 그래프에서 본인 서비스 표시

### **장기 해결책**
1. **현준이 방식 적용**: 직접 Tempo/Loki 연결
2. **상세 로깅 추가**: 비즈니스 로직 로그 강화
3. **시스템 관리자 협의**: Collector 설정 개선

---

## 📝 결론

**현준이의 서비스가 그래프에 표시되는 이유:**
1. **Collector 우회**: Tempo/Loki 직접 연결로 SpanMetrics 문제 회피
2. **수동 로깅**: 상세한 비즈니스 로그로 메트릭 품질 향상
3. **직접 메트릭 생성**: Tempo에서 서비스 그래프용 메트릭 직접 생성

**본인의 서비스가 안 보이는 이유:**
1. **Collector 의존성**: SpanMetrics 프로세서 없어서 메트릭 변환 불가
2. **자동 계측 한계**: 기본 HTTP 로그만으로 서비스 그래프 메트릭 부족
3. **설정 차이**: 표준 OpenTelemetry vs 커스텀 직접 연결

**해결책**: 현준이와 같은 방식으로 직접 엔드포인트 연결하면 서비스 그래프에 정상 표시됩니다.

---

*분석 일시: 2025-09-01*  
*분석자: AI Assistant*  
*대상: K8s 마이크로서비스 데모 프로젝트*
